---
name: Preview PR on Surge

on:
  issue_comment:
    types:
      - created

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: preview-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: true

jobs:
  preview:
    runs-on: ubuntu-latest
    # Run only if it's a /preview comment on a pull request (not an issue)
    if: >
      github.event_name == 'issue_comment' &&
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/preview')

    steps:
      - name: Resolve PR number
        shell: bash
        run: |
          echo "PR_NUMBER=${{ github.event.issue.number }}" >> $GITHUB_ENV
          echo "Resolved PR_NUMBER=${{ github.event.issue.number }}"

      - name: Comment PR with preview starting
        id: start_comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            const serverUrl = process.env.GITHUB_SERVER_URL;
            const repo = process.env.GITHUB_REPOSITORY;
            const runId = process.env.GITHUB_RUN_ID;
            const runUrl = `${serverUrl}/${repo}/actions/runs/${runId}`;
            const body = `‚è≥ **Preview build in progress...**\n\n` +
                         `üîó [View workflow run](${runUrl})`;
            const { data: comment } = await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
            core.setOutput('comment_id', comment.id);

      # Checkout PR merge ref
      - name: Checkout PR (merge ref)
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ env.PR_NUMBER }}/merge

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Surge
        run: npm install -g surge

      - name: Check SURGE_TOKEN
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: |
          if [ -z "$SURGE_TOKEN" ]; then
            echo "‚ùå ERROR: SURGE_TOKEN is not set!"
            echo ""
            echo "SURGE_TOKEN is mandatory to deploy to surge.sh."
            echo ""
            echo "To generate a token:"
            echo "  1. Install surge: npm install -g surge"
            echo "  2. Login: surge login"
            echo "  3. Generate token: surge token"
            echo ""
            echo "Then add the token as a secret in GitHub Actions:"
            echo "  Repository Settings > Secrets and variables >"
            echo "  Actions > New repository secret"
            echo "  Name: SURGE_TOKEN"
            echo "  Value: <your token from 'surge token' command>"
            echo ""
            exit 1
          fi
          echo "‚úì SURGE_TOKEN is set"

      - name: Inject preview banner
        run: |
          # Copy preview banner script and replace placeholders
          PR_NUMBER="${{ env.PR_NUMBER }}"
          REPO_URL="${{ github.server_url }}/${{ github.repository }}"

          # Copy the banner script and replace placeholders
          cp scripts/preview-banner.js /tmp/preview-banner.js
          sed -i "s|PR_NUM_PLACEHOLDER|$PR_NUMBER|g" /tmp/preview-banner.js
          sed -i "s|REPO_URL_PLACEHOLDER|$REPO_URL|g" /tmp/preview-banner.js

          # Inject into HTML using awk (before closing body tag)
          awk -v script="$(cat /tmp/preview-banner.js)" \
            '/<\/body>/ { print "<script>"; print script; print "</script>" } \
             { print }' docs/index.html > /tmp/index-with-banner.html

          # Replace original file
          mv /tmp/index-with-banner.html docs/index.html

          echo "‚úì Preview banner injected"

      - name: Deploy to Surge
        env:
          SURGE_TOKEN: ${{ secrets.SURGE_TOKEN }}
        run: |
          set -euo pipefail
          DOMAIN="pr-${{ env.PR_NUMBER }}-tennis-paris-preview.surge.sh"
          surge ./docs --domain "$DOMAIN" --token "$SURGE_TOKEN"
          echo "DEPLOY_URL=https://$DOMAIN" >> $GITHUB_ENV

      - name: Update PR comment with preview link
        if: success()
        uses: actions/github-script@v7
        env:
          COMMENT_ID: ${{ steps.start_comment.outputs.comment_id }}
          PREVIEW_URL: ${{ env.DEPLOY_URL }}
        with:
          script: |
            const commentId = Number(process.env.COMMENT_ID);
            const previewUrl = process.env.PREVIEW_URL || 'unavailable';
            const body = `üöÄ **Preview deployed successfully!**\n\n` +
                         `üåê Preview: [${previewUrl}](${previewUrl})`;
            await github.rest.issues.updateComment({
              comment_id: commentId,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });

      - name: Update PR comment on failure
        if: failure() && steps.start_comment.outputs.comment_id
        uses: actions/github-script@v7
        env:
          COMMENT_ID: ${{ steps.start_comment.outputs.comment_id }}
        with:
          script: |
            const commentId = Number(process.env.COMMENT_ID);
            const serverUrl = process.env.GITHUB_SERVER_URL;
            const repo = process.env.GITHUB_REPOSITORY;
            const runId = process.env.GITHUB_RUN_ID;
            const runUrl = `${serverUrl}/${repo}/actions/runs/${runId}`;
            const body = `‚ùå **Preview build failed.**\n\n` +
                         `üîó [View workflow run](${runUrl})`;
            await github.rest.issues.updateComment({
              comment_id: commentId,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
